/*!
 * jQuery Lifestream Plug-in
 * @version 0.1.0
 * Show a stream of your online activity
 *
 * Copyright 2011, Christian Vuerings - http://denbuzze.com
 */
(function($){var createYqlUrl=function(query){return("http://query.yahooapis.com/v1/public/yql?q=__QUERY__&env=store://datatables.org/alltableswithkeys&format=json").replace("__QUERY__",encodeURIComponent(query))};$.fn.lifestream=function(config){var outputElement=this,settings=jQuery.extend({classname:"lifestream",limit:10},config),data={count:settings.list.length,items:[]},itemsettings=jQuery.extend(true,{},settings),finished=function(inputdata){$.merge(data.items,inputdata);data.items.sort(function(a,b){return(b.date-a.date)});var items=data.items,length=(items.length<settings.limit)?items.length:settings.limit,i=0,item,ul=$('<ul class="'+settings.classname+'"/>');for(;i<length;i++){item=items[i];if(item.html){$('<li class="'+settings.classname+"-"+item.config.service+'">').append(item.html).appendTo(ul)}}outputElement.html(ul)},load=function(){var i=0,j=settings.list.length;delete itemsettings.list;for(;i<j;i++){var config=settings.list[i];if($.fn.lifestream.feeds[config.service]&&$.isFunction($.fn.lifestream.feeds[config.service])&&config.user){config._settings=itemsettings;$.fn.lifestream.feeds[config.service](config,finished)}}};if(!jQuery.tmpl){jQuery.getScript("https://raw.github.com/jquery/jquery-tmpl/master/jquery.tmpl.min.js",load)}else{load()}};$.fn.lifestream.feeds=$.fn.lifestream.feeds||{};$.fn.lifestream.feeds.dailymotion=function(config,callback){var parseDailymotion=function(input){var output=[],list,i=0,j,item;if(input.query&&input.query.count&&input.query.count>0&&input.query.results.rss.channel.item){list=input.query.results.rss.channel.item;j=list.length;for(;i<j;i++){item=list[i];output.push({date:new Date(item.pubDate),config:config,html:'uploaded a video <a href="'+item.link+'">'+item.title+"</a>"})}}return output};$.ajax({url:createYqlUrl('select * from xml where url="http://www.dailymotion.com/rss/user/'+config.user+'"'),dataType:"jsonp",success:function(data){callback(parseDailymotion(data))}})};$.fn.lifestream.feeds.delicious=function f(config,callback){config.template=$.extend({},f.template,config.template);$.ajax({url:"http://feeds.delicious.com/v2/json/"+config.user,dataType:"jsonp",success:function(data){var output=[],i=0,j;if(data&&data.length&&data.length>0){j=data.length;for(;i<j;i++){var item=data[i];output.push({date:new Date(item.dt),config:config,html:$.tmpl(config.template.bookmarkcreation,{url:item.u,title:item.d})})}}callback(output)}})};$.fn.lifestream.feeds.delicious.template={bookmarkcreation:'bookmarked <a href="${url}">${title}</a>'};$.fn.lifestream.feeds.deviantart=function f(config,callback){config.template=$.extend({},f.template,config.template);$.ajax({url:createYqlUrl('select title,link,pubDate from rss where url="http://backend.deviantart.com/rss.xml?q=gallery%3A'+encodeURIComponent(config.user)+'&type=deviation" | unique(field="title")'),dataType:"jsonp",success:function(resp){var output=[],items,item,i=0,j;if(resp.query&&resp.query.count>0){items=resp.query.results.item;j=items.length;for(;i<j;i++){item=items[i];output.push({date:new Date(item.pubDate),config:config,html:$.tmpl(config.template.deviationpost,{url:item.link,title:item.title})})}}callback(output)}})};$.fn.lifestream.feeds.deviantart.template={deviationpost:'posted <a href="${url}">${title}</a>'};$.fn.lifestream.feeds.dribbble=function(config,callback){var parseDribbbleItem=function(item){var output='posted a shot <a href="'+item.url+'">'+item.title+"</a>";return output};$.ajax({url:"http://api.dribbble.com/players/"+config.user+"/shots",dataType:"jsonp",success:function(data){var output=[],i=0,j;if(data&&data.total){j=data.shots.length;for(;i<j;i++){var item=data.shots[i];output.push({date:new Date(item.created_at),config:config,html:parseDribbbleItem(item)})}}callback(output)}})};$.fn.lifestream.feeds.flickr=function(config,callback){var parseFlickrItem=function(item){var output='posted a photo <a href="'+item.link+'">'+item.title+"</a>";return output};$.ajax({url:"http://api.flickr.com/services/feeds/photos_public.gne?id="+config.user+"&lang=en-us&format=json",dataType:"jsonp",jsonp:"jsoncallback",success:function(data){var output=[],i=0,j;if(data&&data.items&&data.items.length>0){j=data.items.length;for(;i<j;i++){var item=data.items[i];output.push({date:new Date(item.published),config:config,html:parseFlickrItem(item)})}}callback(output)}})};$.fn.lifestream.feeds.forrst=function(config,callback){var parseForrstItem=function(item){return"Posted a "+item.post_type+' titled <a href="'+item.post_url+'">'+item.title+"</a>"};$.ajax({url:"http://forrst.com/api/v2/users/posts?username="+config.user,dataType:"jsonp",success:function(data){var output=[],i=0,j;if(data&&data.resp.length&&data.resp.length>0){j=data.resp.length;for(;i<j;i++){var item=data.resp[i];output.push({date:new Date(item.created_at),config:config,html:parseForrstItem(item)})}}callback(output)}})};$.fn.lifestream.feeds.foursquare=function(config,callback){var parseFoursquareStatus=function(item){var output='checked in @ <a href="'+item.link+'">'+item.title+"</a>";return output},parseFoursquare=function(input){var output=[],i=0,j;if(input.query&&input.query.count&&input.query.count>0){j=input.query.count;for(;i<j;i++){var status=input.query.results.item[i];output.push({date:new Date(status.pubDate),config:config,html:parseFoursquareStatus(status)})}}return output};$.ajax({url:createYqlUrl('select * from rss where url="https://feeds.foursquare.com/history/'+config.user+'.rss"'),dataType:"jsonp",success:function(data){callback(parseFoursquare(data))}})};$.fn.lifestream.feeds.github=function(config,callback){var returnRepo=function(status){return status.payload.repo||status.repository.owner+"/"+status.repository.name},parseGithubStatus=function(status){var output="",name,repo,title,type;if(status.type==="PushEvent"){title="";repo=returnRepo(status);if(status.payload&&status.payload.shas&&status.payload.shas.json&&status.payload.shas.json[2]){title=status.payload.shas.json[2]+" by "+status.payload.shas.json[3]}output+='<a href="'+status.url+'" title="'+title+'">pushed</a> to <a href="http://github.com/'+repo+'">'+repo+"</a>"}else{if(status.type==="GistEvent"){title=status.payload.desc||"";output+=status.payload.action+'d <a href="'+status.payload.url+'" title ="'+title+'">'+status.payload.name+"</a>"}else{if(status.type==="CommitCommentEvent"||status.type==="IssueCommentEvent"){repo=returnRepo(status);output+='<a href="'+status.url+'">commented</a> on <a href="http://github.com/'+repo+'">'+repo+"</a>"}else{if(status.type==="PullRequestEvent"){repo=status.payload.repo||status.repository.owner+"/"+status.repository.name;output+='<a href="'+status.url+'">'+status.payload.action+'</a> pull request on <a href="http://github.com/'+repo+'">'+repo+"</a>"}else{if(status.type==="CreateEvent"&&(status.payload.ref_type==="tag"||status.payload.ref_type==="branch"||status.payload.object==="tag")){repo=returnRepo(status);type=status.payload.ref_type||status.payload.object;name=status.payload.ref||status.payload.object_name;output+="created "+type+' <a href="'+status.url+'">'+name+'</a> for <a href="http://github.com/'+repo+'">'+repo+"</a>"}else{if(status.type==="CreateEvent"){name=(status.payload.object_name==="null")?status.payload.name:status.payload.object_name;output+="created "+status.payload.object+' <a href="'+status.url+'">'+name+"</a>"}else{if(status.type==="DeleteEvent"){output+="deleted "+status.payload.ref_type+' <a href="http://github.com/'+status.repository.owner+"/"+status.repository.name+'">'+status.payload.ref+"</a>"}}}}}}}return output},parseGithub=function(input){var output=[],i=0,j;if(input.query&&input.query.count&&input.query.count>0){j=input.query.count;for(;i<j;i++){var status=input.query.results.json[i].json;output.push({date:new Date(status.created_at),config:config,html:parseGithubStatus(status)})}}return output};$.ajax({url:createYqlUrl('select json.repository.owner,json.repository.name,json.payload,json.type,json.url, json.created_at from json where url="http://github.com/'+config.user+'.json"'),dataType:"jsonp",success:function(data){callback(parseGithub(data))}})};$.fn.lifestream.feeds.googlereader=function(config,callback){var parseReaderEntry=function(entry){return'starred post <a href="'+entry.link.href+'">'+entry.title.content+"</a>"},parseReader=function(input){var output=[],list,i=0,j;if(input.query&&input.query.count&&input.query.count>0){list=input.query.results.feed.entry;j=list.length;for(;i<j;i++){var entry=list[i];output.push({date:new Date(parseInt(entry["crawl-timestamp-msec"],10)),config:config,html:parseReaderEntry(entry)})}}return output};$.ajax({url:createYqlUrl('select * from xml where url="www.google.com/reader/public/atom/user%2F'+config.user+'%2Fstate%2Fcom.google%2Fstarred"'),dataType:"jsonp",success:function(data){callback(parseReader(data))}})};$.fn.lifestream.feeds.iusethis=function(config,callback){var parseIusethis=function(input){var output=[],list,i,j,k,l,m=0,n,item,title,actions,action,what,os,oss=["iPhone","OS X","Windows"];if(input.query&&input.query.count&&input.query.count>0&&input.query.results.rss){n=input.query.results.rss.length;actions=["started using","stopped using","stopped loving","Downloaded","commented on","updated entry for","started loving","registered"];l=actions.length;for(;m<n;m++){os=oss[m];list=input.query.results.rss[m].channel.item;i=0;j=list.length;for(;i<j;i++){item=list[i];title=item.title.replace(config.user+" ","");k=0;for(;k<l;k++){if(title.indexOf(actions[k])>-1){action=actions[k];break}}what=title.split(action);output.push({date:new Date(item.pubDate),config:config,html:action.toLowerCase()+' <a href="'+item.link+'">'+what[1]+"</a> ("+os+")"})}}}return output};$.ajax({url:createYqlUrl('select * from xml where url="http://iphone.iusethis.com/user/feed.rss/'+config.user+'" or url="http://osx.iusethis.com/user/feed.rss/'+config.user+'" or url="http://win.iusethis.com/user/feed.rss/'+config.user+'"'),dataType:"jsonp",success:function(data){callback(parseIusethis(data))}})};$.fn.lifestream.feeds.lastfm=function(config,callback){var parseLastfmEntry=function(entry){var output="";output+='loved <a href="'+entry.url+'">'+entry.name+'</a> by <a href="'+entry.artist.url+'">'+entry.artist.name+"</a>";return output},parseLastfm=function(input){var output=[],list,i=0,j;if(input.query&&input.query.count&&input.query.count>0&&input.query.results.lovedtracks&&input.query.results.lovedtracks.track){list=input.query.results.lovedtracks.track;j=list.length;for(;i<j;i++){var entry=list[i];output.push({date:new Date(parseInt((entry.date.uts*1000),10)),config:config,html:parseLastfmEntry(entry)})}}return output};$.ajax({url:createYqlUrl('select * from xml where url="http://ws.audioscrobbler.com/2.0/user/'+config.user+'/lovedtracks.xml"'),dataType:"jsonp",success:function(data){callback(parseLastfm(data))}})};$.fn.lifestream.feeds.picplz=function(config,callback){var parsePicplzItem=function(item){var imagename=item.caption||item.id;return'Uploaded <a href="'+item.pic_files["640r"].img_url+'">'+imagename+"</a>"};$.ajax({url:"http://picplz.com/api/v2/user.json?username="+config.user+"&include_pics=1",dataType:"jsonp",success:function(data){var output=[],i=0,j,images;images=data.value.users[0].pics;if(images&&images.length&&images.length>0){j=images.length;for(;i<j;i++){var item=images[i];output.push({date:new Date((item.date)*1000),config:config,html:parsePicplzItem(item)})}}callback(output)}})};$.fn.lifestream.feeds.pinboard=function(config,callback){var parsePinboard=function(input){var output=[],list,i=0,j,item;if(input.query&&input.query.count&&input.query.count>0){list=input.query.results.RDF.item;j=list.length;for(;i<j;i++){item=list[i];output.push({date:new Date(item.date),config:config,html:'added bookmark <a href="'+item.link+'">'+item.title+"</a>"})}}return output};$.ajax({url:createYqlUrl('select * from xml where url="http://feeds.pinboard.in/rss/u:'+config.user+'"'),dataType:"jsonp",success:function(data){callback(parsePinboard(data))}})};$.fn.lifestream.feeds.reddit=function(config,callback){var parseRedditItem=function(item){var output="",thread_link="",subreddit_link="http://www.reddit.com/r/"+item.data.subreddit,score=item.data.ups-item.data.downs;score=(score>0)?"+"+score:score;if(item.kind==="t1"){thread_link="http://www.reddit.com/r/"+item.data.subreddit+"/comments/"+item.data.link_id.substring(3)+"/u/"+item.data.name.substring(3)+"?context=3";output+='<a href="'+thread_link+'">commented ('+score+")</a> "}else{if(item.kind==="t3"){output+='<a href="http://www.reddit.com'+item.data.permalink+'">created new thread ('+score+")</a> "}}output+=' in <a href="'+subreddit_link+'">/r/'+item.data.subreddit+"</a>";return output},convertDate=function(date){return new Date(date*1000)};$.ajax({url:"http://www.reddit.com/user/"+config.user+".json",dataType:"jsonp",jsonp:"jsonp",success:function(data){var output=[],i=0,j;if(data&&data.data&&data.data.children&&data.data.children.length>0){j=data.data.children.length;for(;i<j;i++){var item=data.data.children[i];output.push({date:convertDate(item.data.created),config:config,html:parseRedditItem(item)})}}callback(output)}})};$.fn.lifestream.feeds.slideshare=function(config,callback){var parseSlideshare=function(input){var output=[],list,i=0,j,item;if(input.query&&input.query.count&&input.query.count>0){list=input.query.results.rss.channel.item;j=list.length;for(;i<j;i++){item=list[i];output.push({date:new Date(item.pubDate),config:config,html:'uploaded a presentation <a href="'+item.link+'">'+item.title+"</a>"})}}return output};$.ajax({url:createYqlUrl('select * from xml where url="http://www.slideshare.net/rss/user/'+config.user+'"'),dataType:"jsonp",success:function(data){callback(parseSlideshare(data))}})};$.fn.lifestream.feeds.stackoverflow=function(config,callback){var parseStackoverflowItem=function(item){var output="",text="",title="",link="",stackoverflow_link="http://stackoverflow.com/users/"+config.user,question_link="http://stackoverflow.com/questions/";if(item.timeline_type==="badge"){text=item.timeline_type+" "+item.action+": "+item.description;title=item.detail;link=stackoverflow_link+"?tab=reputation"}else{if(item.timeline_type==="revision"||item.timeline_type==="comment"||item.timeline_type==="accepted"||item.timeline_type==="askoranswered"){text=item.post_type+" "+item.action;title=item.detail||item.description||"";link=question_link+item.post_id}}output+='<a href="'+link+'" title="'+title+'">'+text+"</a> - "+title;return output},convertDate=function(date){return new Date(date*1000)};$.ajax({url:"http://api.stackoverflow.com/1.1/users/"+config.user+"/timeline?jsonp",dataType:"jsonp",jsonp:"jsonp",success:function(data){var output=[],i=0,j;if(data&&data.total&&data.total>0&&data.user_timelines){j=data.user_timelines.length;for(;i<j;i++){var item=data.user_timelines[i];output.push({date:convertDate(item.creation_date),config:config,html:parseStackoverflowItem(item)})}}callback(output)}})};$.fn.lifestream.feeds.tumblr=function(config,callback){var getTitle=function(post){var title=post["regular-title"]||post["quote-text"]||post["conversation-title"]||post["photo-caption"]||post["video-caption"]||post["audio-caption"]||post["regular-body"]||post["link-text"]||post.type||"";return title.replace(/<.+?>/gi," ")},createTumblrOutput=function(config,post){return{date:new Date(post.date),config:config,html:"posted a "+post.type+' <a href="'+post.url+'">'+getTitle(post)+"</a>"}},parseTumblr=function(input){var output=[],i=0,j,post;if(input.query&&input.query.count&&input.query.count>0){if($.isArray(input.query.results.posts.post)){j=input.query.results.posts.post.length;for(;i<j;i++){post=input.query.results.posts.post[i];output.push(createTumblrOutput(config,post))}}else{if($.isPlainObject(input.query.results.posts.post)){output.push(createTumblrOutput(config,input.query.results.posts.post))}}}return output};$.ajax({url:createYqlUrl('select * from tumblr.posts where username="'+config.user+'"'),dataType:"jsonp",success:function(data){callback(parseTumblr(data))}})};$.fn.lifestream.feeds.twitter=function(config,callback){var linkify=function(tweet){var link=function(t){return t.replace(/[a-z]+:\/\/[a-z0-9-_]+\.[a-z0-9-_:~%&\?\/.=]+[^:\.,\)\s*$]/ig,function(m){return'<a href="'+m+'">'+((m.length>25)?m.substr(0,24)+"...":m)+"</a>"})},at=function(t){return t.replace(/(^|[^\w]+)\@([a-zA-Z0-9_]{1,15})/g,function(m,m1,m2){return m1+'<a href="http://twitter.com/'+m2+'">@'+m2+"</a>"})},hash=function(t){return t.replace(/(^|[^\w'"]+)\#([a-zA-Z0-9_]+)/g,function(m,m1,m2){return m1+'<a href="http://search.twitter.com/search?q=%23'+m2+'">#'+m2+"</a>"})};return hash(at(link(tweet)))},addTwitterLinks=function(tweet){return linkify(tweet).replace(/ #([A-Za-z0-9\/\.]*)/g,function(m){return' <a target="_new" href="http://twitter.com/search?q='+m.replace(" #","%23")+'">'+m+"</a>"}).replace(/@[\w]+/g,function(m){return'<a href="http://www.twitter.com/'+m.replace("@","")+'">'+m+"</a>"})},parseTwitter=function(input){var output=[],i=0,j;if(input.query&&input.query.count&&input.query.count>0){j=input.query.count;for(;i<j;i++){var status=input.query.results.statuses[i].status;output.push({date:new Date(status.created_at),config:config,html:addTwitterLinks(status.text)})}}return output};$.ajax({url:createYqlUrl('select status.id, status.created_at, status.text from twitter.user.timeline where screen_name="'+config.user+'"'),dataType:"jsonp",success:function(data){callback(parseTwitter(data))}})};$.fn.lifestream.feeds.vimeo=function(config,callback){var parseVimeoItem=function(item){return'published a video <a href="'+item.url+'" title="'+item.description.replace(/"/g,"'").replace(/<.+?>/gi,"")+'">'+item.title+"</a>"},parseVimeo=function(input){var output=[],i=0,j,item;if(input){j=input.length;for(;i<j;i++){item=input[i];output.push({date:new Date(item.upload_date),config:config,html:parseVimeoItem(item)})}}return output};$.ajax({url:"http://vimeo.com/api/v2/"+config.user+"/videos.json",dataType:"jsonp",crossDomain:true,success:function(data){callback(parseVimeo(data))}})};$.fn.lifestream.feeds.youtube=function(config,callback){var parseYoutubeItem=function(item){return' favorited <a href="'+item.video.player["default"]+'" title="'+item.video.description+'">'+item.video.title+"</a>"},parseYoutube=function(input){var output=[],i=0,j,item;if(input.data&&input.data.items){j=input.data.items.length;for(;i<j;i++){item=input.data.items[i];output.push({date:new Date(item.created),config:config,html:parseYoutubeItem(item)})}}return output};$.ajax({url:"http://gdata.youtube.com/feeds/api/users/"+config.user+"/favorites?v=2&alt=jsonc",dataType:"jsonp",success:function(data){callback(parseYoutube(data))}})}}(jQuery));