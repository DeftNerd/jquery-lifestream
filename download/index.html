<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Custom Download Builder</title>
  <link rel="stylesheet" type="text/css" href="css/style.css">
  <link href="css/style.css" rel="stylesheet" type="text/css" />
  <!-- <link href="../css/lifestream.css" rel="stylesheet" type="text/css" /> -->
</head>
<body>
  <form action="#">
    <fieldset>
      <legend>Custom Download Builder</legend>
      <div id="button-bar">
        <button id="button">Build Script</button>
      </div>
    </fieldset>
  </form>
  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write('<script src="http://code.jquery.com/jquery-1.6.1.min.js"><\/script>');</script>
  <script src="js/swfobject.min.js"></script> 
  <script src="js/downloadify.min.js"></script> 
  <script src="js/jquery.notifications.min.js"></script>
  <script src="js/uglifyjs-cs.min.js"></script>
  <script>
    $.n.defaults.timeout = 8000;
    
    var
      $button = $('#button'),
      $downloadify,
      builtScript = '',
      downloadifyContainer
    ;
    // Fetch the service list
    $.n('Fetching available services...');
    $.ajax({
      url: 'services.json',
      dataType: 'json',
      success: buildUI
    });
    
    function buildUI(services) {
      //$('#startup-feedback').hide();
      $.n(services.length + ' services available');
      
      // Build the service checkboxes markup
      (function(numCols, c, $after, $c, i) {
        for (
          c = 0, 
          $after = $('legend'), 
          $c = $('<div class="col"></div>').insertAfter($after); 
          c < numCols; 
          ++c, $after = $c, $c = $('<div class="col"></div>').insertAfter($after))
            for (i = c; i < services.length; i += numCols)
              $c.append(
                '<div>' +
                '<label for="' + services[i] + '">' +
                '<input type="checkbox" id="' + services[i] + '">'+
                services[i] + '</label></div>');
      })(4);
      
      $button
        .attr('disabled', 'disabled')
        .click(function (e) { e.preventDefault(); build(); })
        //.show()
      ;

      // 'Build Script' button must be enabled only
      // if there is >= 1 services selected
      $('form').delegate(
        'form input[type="checkbox"]',
        'change',
        (function() {
          var c = 0;
          return function() {
            this.checked? c++ : c--;
            if (c > 0)
              $button.removeAttr('disabled');
            else
              $button.attr('disabled', 'disabled');
          }
        })()
      );

      downloadifyContainer = Downloadify.create('button-bar', {
        filename: function(){
          return 'jquery.lifestream.min.js';
        },
        data: function(){ 
          return builtScript;
        },
        onComplete: onDownloadComplete,
        //onCancel: function(){ alert('You have cancelled the saving of this file.'); },
        onError: function(){ alert('You must put something in the File Contents or there will be nothing to save!'); },
        transparent: false,
        swf: 'js/downloadify.swf',
        downloadImage: 'img/button-download.png',
        width: 123, //144, //100,
        height: 35, //41, //30,
        append: true
      });
    }
    downloadifyContainer.disable();
    
    function build() {
      $.n('Build started');
     
      // Disable checkboxes?
      
      // Disable Build button
      //$('#services input[type="checkbox"]').button('disable');
        
      buildScript(
        $('input[type="checkbox"]')
          .filter(':checked')
          .map(function() { return $(this).attr('id')})
          .get(),
        onBuildCompleted
      );
    }
    
    function onBuildCompleted(minifiedScript) {
      $.n('Build completed');
      
      builtScript = minifiedScript;
      
      // Enable Download button
      //$downloadify.css({visibility: 'visible'});
    }
    
    function onDownloadComplete() { 
      // Enablecheckboxes?
      //$('#services input[type="checkbox"]').button('enable');
      
      // Disable Download button
      //$('#button-bar > object').css({visibility: 'hidden'});
      
      // Enable Buildbutton
    }
    
    function buildScript(services, success) {
      var 
        out = [],
        countdown = 1 + services.length,
        concat = function(scriptText) {
          out.push(scriptText);
          if (!--countdown) {
            $.n('All src moduled received');
            $.n('Uglification...');
            success(uglify(out.join(';')));
          }
        }
      ;
      
      $.n('Fetching src modules...');
      $.getScript('../src/core.js', function(scriptText) {
        concat(scriptText);
        
        // The services scripts are not (necessarily) 
        // concatened in the same order as in the services array.
        // We don't need to preserve that order so we can
        // just fire all the script requests (potentially)
        // speeding up the process.
        $.each(services, function(i, f) {
          $.getScript('../src/services/' + f + '.js', function(scriptText) {
            concat(scriptText);
          });
        });
      });
    }
  </script>
</body>
</html>