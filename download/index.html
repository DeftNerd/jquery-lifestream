<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Custom Download Builder</title>
	<link rel="stylesheet" type="text/css" href="css/dark-hive/jquery.ui.core.css">
	<link rel="stylesheet" type="text/css" href="css/dark-hive/jquery.ui.button.css">
	<link rel="stylesheet" type="text/css" href="css/dark-hive/jquery.ui.theme.css">
	<link rel="stylesheet" type="text/css" href="css/style.css">
</head>

<body>
	<div id="widget">
		<div id="header">
			<h1><a href="#"><!--<img src="img/widget-header-logo.png">--></a>Custom Download Builder</h1>
		</div>
		<div id="content">
			<ul id="services"></ul>
			<div id="button-bar">
				<span id="startup-feedback">Loading, Please wait...</span>
				<button id="button">Build Script</button>
			</div>
		</div>
		<div id="footer"></div>
	</div>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
	<script>!window.jQuery && document.write('<script src="http://code.jquery.com/jquery-1.6.1.min.js"><\/script>');</script>
	<!--<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.14/jquery-ui.min.js"></script>-->
	<script src="js/jquery-ui-1.8.14.custom.min.js"></script>
	<script src="js/swfobject.min.js"></script> 
	<script src="js/downloadify.min.js"></script> 
	<script src="js/jquery.notifications.min.js"></script>
	<script src="js/uglifyjs-cs.min.js"></script>
	<script>
		// TODO: Check if we have all deps loading
		
		$.n.defaults.timeout = 8000;
		var
			$button = $('#button'),
			$downloadify,
			builtScript = ''
		;
		
		imagePreloading(
			'img/services-deselected.png',
			'img/services-hover.png',
			'img/services-selected.png',
			'img/button-download.png'
		);
  
		// Fetch the service list
		$.n('Fetching available services...');
		$.ajax({
			url: 'services.txt',
			dataType: 'text',
			success: function(data) {
				buildUI(data.trim().split('\n'));
			}
		});
		
		function buildUI(services) {
			$('#startup-feedback').hide();
			$.n(services.length + ' services available');
			
			// Build the service checkboxes
			var out = [];
			$.each(services.sort(), function(i, f) { 
				out.push(
					'<li><input id="' + f + '" type="checkbox"><label for="' + f + '">' + f + '</label></li>');
			});
			out.push('<br class="clear">');
			$('#services').append(out.join(''));
	  
			// PE of service checkboxes
			var c = 0;
			$('#services input[type="checkbox"]')
				.each(function() {
					$(this).button({
						text: false,
						icons: {
							primary: 'ui-icon-service-' + this.id
						},
					});
				})
				.change(function(e) {
					if (this.checked)
						c++;
					else
						c--;
					if (c > 0)
						$button.button('enable');
					else
						$button.button('disable');
				})
			;
	  
			$button
				.button({
					icons: { primary: 'ui-icon-gear' },
					disabled: true
				})
				.click(function() {
					build();
					return false;
				})
				.show()
			;
			
			Downloadify.create('button-bar', {
				filename: function(){
					return 'jquery.lifestream.min.js';
				},
				data: function(){ 
					return builtScript;
				},
				onComplete: onDownloadComplete,
				//onCancel: function(){ alert('You have cancelled the saving of this file.'); },
				onError: function(){ alert('You must put something in the File Contents or there will be nothing to save!'); },
				transparent: false,
				swf: 'js/downloadify.swf',
				downloadImage: 'img/button-download.png',
				width: 123, //144, //100,
				height: 35, //41, //30,
				append: true
			});
			$downloadify = $('#button-bar > object')
				.css({visibility: 'hidden'});
		}
		
		function build() {
			$.n('Build started');
		 
			// Disable UI
			//$('body').addClass('waiting');
			$('#services input[type="checkbox"]').button('disable');
			$button
				.button({
					disabled: true,
					label: 'Wait...',
					icons: { primary: 'ui-icon-spinner' }
				});
				
			buildScript(
				$('#services input[type="checkbox"]')
					.filter(':checked')
					.map(function() { return $(this).attr('id')})
					.get(),
				onBuildCompleted
			);
			/*
			concatMinifiedScripts(
				$('#services input[type="checkbox"]')
					.filter(':checked')
					.map(function() { return $(this).attr('id')})
					.get(),
				onBuildCompleted
			);
			*/
		}
		
		function onBuildCompleted(out) {
			$.n('Build completed');
			
			builtScript = out;
			
			$button
			  .button('disable')
			  //.button('destroy')
			  .hide()
			;
			
			$downloadify.css({visibility: 'visible'});
		}
		
		function onDownloadComplete() { 
			// Re-enable UI
			//$('body').removeClass('waiting');
			$('#services input[type="checkbox"]').button('enable');
			
			//$('#downloadify').hide();
			$('#button-bar > object').css({visibility: 'hidden'});
			
			$button.button({
				icons: { primary: 'ui-icon-gear' },
				label: 'Build script'
			})
			.button('enable')
			.show();
		}

		function buildScript(services, success) {
			var 
				out = [],
				countdown = 1 + services.length,
				concat = function(scriptText) {
					out.push(scriptText);
					if (!--countdown) {
						$.n('All src moduled received');
						$.n('Uglification...');
						success(uglify(out.join(';')));
					}
				}
			;
			
			$.n('Fetching src modules...');
			$.getScript('../src/core.js', function(scriptText) {
				concat(scriptText);
				
				// The services scripts are not (necessarily) 
				// concatened in the same order as in the services array.
				// We don't need to preserve that order so we can
				// just fire all the script requests (potentially)
				// speeding up the process.
				$.each(services, function(i, f) {
					$.getScript('../src/services/' + f + '.js', function(scriptText) {
						concat(scriptText);
					});
				});
			});
		}
		
		function imagePreloading() {
			var img = new Image(), i = 0, n = arguments.length;
			while (i < n)
				img.src = arguments[i++];
		}
	</script>
</body>
</html>