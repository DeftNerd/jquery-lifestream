<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Custom Download Builder</title>
	<link rel="stylesheet" type="text/css" href="css/dark-hive/jquery.ui.core.css">
	<link rel="stylesheet" type="text/css" href="css/dark-hive/jquery.ui.button.css">
	<link rel="stylesheet" type="text/css" href="css/dark-hive/jquery.ui.theme.css">
	<link rel="stylesheet" type="text/css" href="css/style.css">
</head>

<body>
	<div id="widget">
		<div id="header">
			<h1><a href="#"><img src="img/widget-header-logo.png"></a>Custom Download Builder</h1>
		</div>
		<div id="content">
			<ul id="services"></ul>
			<div id="button-bar"><a id="button" href="#">Build script</a></div>
		</div>
		<div id="footer"></div>
	</div>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.js"></script>
	<script>!window.jQuery && document.write('<script src="http://code.jquery.com/jquery-1.6.1.min.js"><\/script>');</script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.14/jquery-ui.min.js"></script>
	<script type="text/javascript" src="js/swfobject.js"></script> 
	<script type="text/javascript" src="js/downloadify.min.js"></script> 
	<script src="js/jquery.notifications.js"></script>
	<script>
		// TODO: Check if we have all deps loading
		
		$.n.defaults.timeout = 10000;
		var
			$button = $('#button')
		;
		
		imagePreloading(
			'img/services-deselected.png',
			'img/services-hover.png',
			'img/services-selected.png'
		);
  
		// Fetch the service list
		$.ajax({
			url: 'services.txt',
			dataType: 'text',
			success: function(data) {
				buildUI(data.trim().split('\n'));
			}
		});
		
		function buildUI(services) {
			// Build the service checkboxes
			var out = [];
			$.each(services.sort(), function(i, f) { 
				out.push(
					'<li><input id="' + f + '" type="checkbox"><label for="' + f + '">' + f + '</label></li>');
			});
			out.push('<br class="clear">');
			$('#services').append(out.join(''));
	  
			// PE of service checkboxes
			var c = 0;
			$('#services input[type="checkbox"]')
				.each(function() {
					$(this).button({
						text: false,
						icons: {
							primary: 'ui-icon-service-' + this.id
						},
					});
				})
				.change(function(e) {
					if (this.checked)
						c++;
					else
						c--;
					if (c > 0)
						$button.button('enable');
					else
						$button.button('disable');
				})
			;
	  
			$button
				.button({
					icons: { primary: 'ui-icon-gear' },
					disabled: true
				})
				.click(function() {
					build();
					return false;
				});
		}
		
		function build() {
			$.n('Build started');
		 
			// Disable UI
			//$('body').addClass('waiting');
			$('#services input[type="checkbox"]').button('disable');
			$button
				.button({
					disabled: true,
					label: 'Wait...',
					icons: { primary: 'ui-icon-spinner' }
				});
		
			concatMinifiedScripts(
				$('#services input[type="checkbox"]')
					.filter(':checked')
					.map(function() { return $(this).attr('id')})
					.get(), 
				{core: '../src/', services: '../src/services/'},
				onBuildCompleted
			);
		}
		
		function onBuildCompleted(out) {
			$.n('Build completed');
			
			$button
			  .button('disable')
			  .button('destroy')
			;
			Downloadify.create('button', {
				filename: function(){
					return 'jquery.lifestream.js';
				},
				data: function(){ 
					return out;
				},
				onComplete: onDownloadComplete,
				//onCancel: function(){ alert('You have cancelled the saving of this file.'); },
				onError: function(){ alert('You must put something in the File Contents or there will be nothing to save!'); },
				transparent: false,
				swf: 'media/downloadify.swf',
				downloadImage: 'img/download-new.png',
				width: 144, //100,
				height: 41, //30,
				transparent: false,
				append: false
			});
		}
		
		function onDownloadComplete() { 
			// Re-enable UI
			//$('body').removeClass('waiting');
			$('#services input[type="checkbox"]').button('enable');
			$button.button({
				icons: { primary: 'ui-icon-gear' },
				label: 'Build script'
			});
		}
  
		function concatMinifiedScripts(services, paths, success) {
			var 
				out = [],
				countdown = 1 + services.length,
				concat = function(scriptText) {
					out.push(scriptText);
					if (!--countdown)
						success(out.join(''));
				}
			;
			
			$.n('Sent request for core.js');
			$.getScript(paths['core'] + 'core.js', function(scriptText) {
				$.n('Received core.js');
				concat(scriptText);
				
				// The services scripts are not (necessarily) 
				// concatened in the same order as in the services array.
				// We don't need to preserve that order so we can
				// just fire all the script requests (potentially)
				// speeding up the process.
				$.each(services, function(i, f) {
					$.n('Sent request for ' + f + '.js');
					$.getScript(paths['services'] + f + '.js', function(scriptText) {
						$.n('Received ' + f + '.js');
						concat(scriptText);
					});
				});
			});
		}
		
		function imagePreloading() {
			var img = new Image(), i = 0, n = arguments.length;
			while (i < n)
				img.src = arguments[i++];
		}
	</script>
</body>
</html>