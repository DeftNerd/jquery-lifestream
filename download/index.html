<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Custom Download Builder</title>
  <link rel="stylesheet" type="text/css" href="css/dark-hive/jquery.ui.core.css">
  <link rel="stylesheet" type="text/css" href="css/dark-hive/jquery.ui.button.css">
  <link rel="stylesheet" type="text/css" href="css/dark-hive/jquery.ui.theme.css">
  <link rel="stylesheet" type="text/css" href="css/style.css">
</head>

<body>
  <div id="widget">
    <div id="header">
      <h1><a href="#"><img src="img/widget-header-logo.png"></a>Custom Download Builder</h1>
    </div>
    <div id="content">
      <ul id="services"></ul>
      <div id="button-bar"><a id="button" href="#">Build script</a></div>
    </div>
    <div id="footer">
    </div>
  </div>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.js"></script>
	<script>!window.jQuery && document.write('<script src="http://code.jquery.com/jquery-1.6.1.min.js"><\/script>');</script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.14/jquery-ui.min.js"></script>
	<script type="text/javascript" src="js/swfobject.js"></script> 
	<script type="text/javascript" src="js/downloadify.min.js"></script> 
	<script src="js/jquery.notifications.js"></script>
	<script>
		// TODO: Check if we have all deps loading
		
		imagePreloading(
			'img/services-deselected.png',
			'img/services-hover.png',
			'img/services-selected.png'
		);
		
	$.n.defaults.timeout = 10000;
  
	// Fetch the feeds list.
	var feeds = [ // If we could fetch the available services form somewhere ...
		'blogger',
		'dailymotion',
		'delicious',
		'deviantart',
		'dribbble',
		'flickr',
		'formspring',
		'forrst',
		'foursquare',
		'github',
		'googlereader',
		'iusethis',
		'lastfm',
		'picplz',
		'pinboard',
		'posterous',
		'reddit',
		'slideshare',
		'stackoverflow',
		'tumblr',
		'twitter',
		'vimeo',
		'wordpress',
		'youtube'
	];
  
	// Build the service checkboxes
	var out = [];
	$.each(feeds.sort(), function(i, f) { 
		out.push(
			'<li><input id="' + f + '" type="checkbox"><label for="' + f + '">' + f + '</label></li>');
	});
	out.push('<br class="clear">');
	$('#services').append(out.join(''));
  
  // PE of service checkboxes
  var c = 0;
  $('#services input[type="checkbox"]').each(function() {
    $(this).button({
      text: false,
      icons: {
        primary: 'ui-icon-service-' + this.id
      },
    });
  })
  .change(function(e) {
    if (this.checked)
      c++;
    else
      c--;
    if (c > 0)
      $('#button').button('enable');
    else
      $('#button').button('disable');
  })
  ;
  
  // PE of the button
  $('#button').button({
    icons: { primary: 'ui-icon-gear' },
    disabled: true
  }); //chain it!
  
  $('#button').click(function() {
    $.n('Build started');
    
    // Disable UI
    //$('body').addClass('waiting');
    $('#services input[type="checkbox"]').button('disable');
    $(this)
      .button({
        disabled: true,
        label: 'Wait...',
        icons: { primary: 'ui-icon-spinner' }
      });
    
    concatMinifiedScripts(
		$('#services input[type="checkbox"]')
			.filter(':checked')
			.map(function() { return $(this).attr('id')})
			.get(), 
		{core: '../src/', feeds: '../src/feeds/'},
		function(out) {
			$.n('Build completed');
			
			$('#button')
			  .button('disable')
			  .button('destroy')
			;
			Downloadify.create('button', {
			  filename: function(){
				return 'jquery.lifestream.js';
			  },
			  data: function(){ 
				return out;
			  },
			  onComplete: function() { 
				// Re-enable UI
				//$('body').removeClass('waiting');
				$('#services input[type="checkbox"]').button('enable');
				$('#button').button({
				  icons: { primary: 'ui-icon-gear' },
				  label: 'Build script'
				});
			  },
			  //onCancel: function(){ alert('You have cancelled the saving of this file.'); },
			  onError: function(){ alert('You must put something in the File Contents or there will be nothing to save!'); },
			  transparent: false,
			  swf: 'media/downloadify.swf',
			  downloadImage: 'img/download-new.png',
			  width: 144, //100,
			  height: 41, //30,
			  transparent: false,
			  append: false
			});
		}
    );
    return false;
  });
  
	function concatMinifiedScripts(feeds, paths, success) {
		var 
			out = [],
			countdown = 1 + feeds.length,
			concat = function(scriptText) {
				out.push(scriptText);
				if (!--countdown)
					success(out.join(''));
			}
		;
		
		$.n('Sent request for core.js');
		$.getScript(paths['core'] + 'core.js', function(scriptText) {
			$.n('Received core.js');
			concat(scriptText);
			
			// The feeds scripts are not (necessarily) 
			// concatened in the same order as in the feeds array.
			// We don't need to preserve that order so we can
			// just fire all the script requests (potentially)
			// speeding up the process.
			$.each(feeds, function(i, f) {
				$.n('Sent request for ' + f + '.js');
				$.getScript(paths['feeds'] + f + '.js', function(scriptText) {
				$.n('Received ' + f + '.js');
				concat(scriptText);
			});
		});
    });
  }
		
		function imagePreloading() {
			var img = new Image(), i = 0, n = arguments.length;
			while (i < n)
				img.src = arguments[i++];
		}
	</script>
</body>
</html>